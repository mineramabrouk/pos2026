{% extends 'base.html' %}

{% block title %}Punto de Venta - POS System{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #4f46e5;
        --secondary-color: #64748b;
        --success-color: #10b981;
        --danger-color: #ef4444;
        --background-color: #f3f4f6;
        --card-bg: #ffffff;
    }

    body {
        background-color: var(--background-color);
        font-family: 'Inter', sans-serif;
    }

    .pos-container {
        height: calc(100vh - 70px);
        overflow: hidden;
    }

    /* Product Section */
    .product-section {
        height: 100%;
        overflow-y: auto;
        padding: 1.5rem;
    }

    .search-bar {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: var(--background-color);
        padding-bottom: 1rem;
    }

    .search-input {
        border-radius: 50px;
        padding: 0.75rem 1.5rem;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .search-input:focus {
        box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.1);
        border-color: var(--primary-color);
    }

    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1.5rem;
    }

    .product-card {
        background: var(--card-bg);
        border-radius: 16px;
        border: none;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        overflow: hidden;
        height: 100%;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .product-image-container {
        height: 140px;
        overflow: hidden;
        position: relative;
    }

    .product-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }

    .product-card:hover .product-image {
        transform: scale(1.1);
    }

    .product-info {
        padding: 1rem;
    }

    .product-price {
        color: var(--primary-color);
        font-weight: 700;
        font-size: 1.1rem;
    }

    .stock-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
    }

    /* Cart Section */
    .cart-section {
        background-color: #ffffff;
        border-left: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
        height: 100%;
        box-shadow: -4px 0 15px rgba(0, 0, 0, 0.05);
    }

    .cart-header {
        padding: 1.5rem;
        background-color: #1e293b;
        color: white;
    }

    .cart-items-container {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem;
    }

    .cart-item {
        background: #f8fafc;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        border: 1px solid #e2e8f0;
        transition: all 0.2s;
    }

    .cart-item:hover {
        border-color: var(--primary-color);
        background: white;
    }

    .qty-input {
        width: 60px;
        text-align: center;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        padding: 0.25rem;
    }

    .price-input {
        width: 80px;
        text-align: right;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        padding: 0.25rem;
    }

    .cart-footer {
        padding: 1.5rem;
        background-color: #f8fafc;
        border-top: 1px solid #e2e8f0;
    }

    .total-display {
        font-size: 2rem;
        font-weight: 800;
        color: #1e293b;
        text-align: right;
        margin-bottom: 1rem;
    }

    .btn-checkout {
        background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
        color: white;
        border: none;
        padding: 1rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1.1rem;
        width: 100%;
        transition: all 0.3s;
    }

    .btn-checkout:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3);
    }

    .btn-checkout:disabled {
        background: #cbd5e1;
        transform: none;
        box-shadow: none;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
        width: 6px;
    }

    ::-webkit-scrollbar-track {
        background: transparent;
    }

    ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-0 pos-container">
    <!-- Product List Column -->
    <div class="col-md-8 product-section">
        <div class="search-bar">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0 rounded-start-pill ps-4">
                    <i class="bi bi-search text-muted"></i>
                </span>
                <input type="text" id="searchInput" class="form-control border-start-0 search-input"
                    placeholder="Buscar productos por nombre o código de barras...">
                <button class="btn btn-primary rounded-end-pill px-4" type="button" id="searchBtn">
                    Buscar
                </button>
            </div>
        </div>

        <div id="productList" class="product-grid">
            <!-- Products will be rendered here -->
        </div>
    </div>

    <!-- Cart Column -->
    <div class="col-md-4 cart-section">
        <div class="cart-header d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0 fw-bold"><i class="bi bi-cart3 me-2"></i>Venta Actual</h4>
                <small class="text-white-50" id="cartDate">Fecha: --/--/----</small>
            </div>
            <span class="badge bg-primary rounded-pill fs-6" id="cartCount">0</span>
        </div>

        <div class="cart-items-container" id="cartItemsContainer">
            <!-- Cart items will be rendered here -->
            <div id="emptyCartMessage" class="text-center py-5 text-muted">
                <div class="mb-3">
                    <i class="bi bi-basket display-1 text-secondary opacity-25"></i>
                </div>
                <h5>El carrito está vacío</h5>
                <p class="small">Selecciona productos para comenzar una venta</p>
            </div>
        </div>

        <div class="cart-footer">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-muted">Subtotal</span>
                <span class="fw-bold" id="subtotalAmount">Bs 0.00</span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-4">
                <span class="fs-5 fw-bold">Total a Pagar</span>
                <div class="total-display" id="totalAmount">Bs 0.00</div>
            </div>

            <div class="d-grid gap-2">
                <button class="btn btn-checkout" onclick="checkout()" id="checkoutBtn" disabled>
                    <i class="bi bi-credit-card me-2"></i> Cobrar
                </button>
                <button class="btn btn-outline-danger border-0" onclick="resetCart()" id="cancelBtn" disabled>
                    <i class="bi bi-trash me-2"></i> Cancelar Venta
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-body text-center py-5">
                <div class="mb-4">
                    <div class="rounded-circle bg-success bg-opacity-10 d-inline-flex p-4">
                        <i class="bi bi-check-lg text-success display-4"></i>
                    </div>
                </div>
                <h3 class="fw-bold mb-2">¡Venta Exitosa!</h3>
                <p class="text-muted mb-4">La transacción se ha registrado correctamente.</p>

                <div class="bg-light p-3 rounded-3 mb-4 d-inline-block">
                    <small class="text-uppercase text-muted fw-bold">Nro. Recibo</small>
                    <div class="fs-4 fw-mono text-dark" id="receiptNumber">REC-000000</div>
                </div>

                <div class="d-grid gap-2 col-8 mx-auto">
                    <a href="#" id="printReceiptBtn" target="_blank" class="btn btn-dark btn-lg">
                        <i class="bi bi-printer me-2"></i> Imprimir Recibo
                    </a>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal"
                        onclick="resetCart()">
                        Nueva Venta
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-cart-check me-2"></i>Confirmar Venta</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-striped mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Producto</th>
                                <th class="text-center">Cant.</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="confirmationItems">
                            <!-- Items will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div class="p-3 bg-light border-top">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="h5 mb-0 text-muted">Total a Pagar:</span>
                        <span class="h3 mb-0 fw-bold text-primary" id="confirmationTotal">Bs 0.00</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary px-4" onclick="processSale()" id="confirmSaleBtn">
                    <i class="bi bi-check-lg me-2"></i>Confirmar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const allProducts = {{ products_json| safe }};
    let cart = [];

    // DOM Elements
    const productListEl = document.getElementById('productList');
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const cartItemsContainer = document.getElementById('cartItemsContainer');
    const emptyCartMessage = document.getElementById('emptyCartMessage');
    const cartCountEl = document.getElementById('cartCount');
    const totalAmountEl = document.getElementById('totalAmount');
    const subtotalAmountEl = document.getElementById('subtotalAmount');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const checkoutModal = new bootstrap.Modal(document.getElementById('checkoutModal'));
    const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    const confirmSaleBtn = document.getElementById('confirmSaleBtn');
    const confirmationItems = document.getElementById('confirmationItems');
    const confirmationTotal = document.getElementById('confirmationTotal');
    const printReceiptBtn = document.getElementById('printReceiptBtn');

    // Set Date
    document.getElementById('cartDate').textContent = new Date().toLocaleDateString();

    // Auto-focus search input
    if (searchInput) {
        searchInput.focus();
    }

    // Search Logic
    function performSearch() {
        if (!searchInput) return;

        const term = searchInput.value.toLowerCase().trim();

        if (!term) {
            renderProducts(allProducts);
            return;
        }

        const filtered = allProducts.filter(p => {
            const nameMatch = p.name.toLowerCase().includes(term);
            const barcodeMatch = p.barcode && p.barcode.toLowerCase().includes(term);
            return nameMatch || barcodeMatch;
        });

        renderProducts(filtered);
    }

    // Event Listeners for Search
    if (searchInput) {
        searchInput.addEventListener('input', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    }

    if (searchBtn) {
        searchBtn.addEventListener('click', performSearch);
    }

    // Initial Render
    renderProducts(allProducts);

    function renderProducts(products) {
        console.log('Rendering products:', products);
        if (products.length === 0) {
            productListEl.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="bi bi-search display-1 text-secondary opacity-25"></i>
                    <p class="text-muted mt-3">No se encontraron productos que coincidan con la búsqueda.</p>
                </div>
            `;
            return;
        }

        let html = '';
        for (const p of products) {
            try {
                const price = typeof p.price === 'number' ? p.price.toFixed(2) : parseFloat(p.price).toFixed(2);
                const stockClass = p.stock > 0 ? 'success' : 'danger';
                const imageUrl = p.image_url || '';

                html += `
            <div class="product-card" onclick="addToCart(${p.id})">
                <div class="product-image-container">
                    ${imageUrl ?
                        `<img src="${imageUrl}" class="product-image" alt="${p.name}">` :
                        `<div class="d-flex align-items-center justify-content-center h-100 bg-light text-secondary">
                            <i class="bi bi-box-seam display-4 opacity-50"></i>
                        </div>`}
                </div>
                <div class="product-info">
                    <h6 class="text-truncate mb-1" title="${p.name}">${p.name}</h6>
                    <small class="text-muted d-block mb-2 text-truncate">${p.category}</small>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="product-price">Bs ${price}</span>
                        <span class="stock-badge bg-${stockClass} bg-opacity-10 text-${stockClass}">
                            ${p.stock} unid.
                        </span>
                    </div>
                </div>
            </div>`;
            } catch (e) {
                console.error('Error rendering product:', p, e);
            }
        }
        productListEl.innerHTML = html;
    }

    function addToCart(productId) {
        const product = allProducts.find(p => p.id === productId);
        if (!product || product.stock <= 0) return;

        const existingItem = cart.find(item => item.id === productId);

        if (existingItem) {
            if (existingItem.quantity < product.stock) {
                existingItem.quantity++;
            } else {
                alert('No hay suficiente stock disponible.');
                return;
            }
        } else {
            cart.push({ ...product, quantity: 1, originalPrice: product.price });
        }
        renderCart();
    }

    function updateQuantity(index, newQty) {
        const item = cart[index];
        const qty = parseInt(newQty);
        if (qty > 0 && qty <= item.stock) {
            item.quantity = qty;
        } else if (qty > item.stock) {
            alert(`Solo hay ${item.stock} unidades disponibles.`);
            item.quantity = item.stock;
        } else {
            item.quantity = 1;
        }
        renderCart();
    }

    function updatePrice(index, newPrice) {
        const price = parseFloat(newPrice);
        if (price >= 0) {
            cart[index].price = price;
        }
        renderCart();
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        renderCart();
    }

    function renderCart() {
        if (cart.length === 0) {
            cartItemsContainer.innerHTML = '';
            cartItemsContainer.appendChild(emptyCartMessage);
            emptyCartMessage.style.display = 'block';
            checkoutBtn.disabled = true;
            cancelBtn.disabled = true;
            cartCountEl.textContent = '0';
            totalAmountEl.textContent = 'Bs 0.00';
            subtotalAmountEl.textContent = 'Bs 0.00';
            return;
        }

        emptyCartMessage.style.display = 'none';
        checkoutBtn.disabled = false;
        cancelBtn.disabled = false;
        cartCountEl.textContent = cart.length;

        let total = 0;
        cartItemsContainer.innerHTML = cart.map((item, index) => {
            const subtotal = item.quantity * item.price;
            total += subtotal;
            return `
            <div class="cart-item">
                <div class="d-flex justify-content-between mb-2">
                    <span class="fw-bold text-truncate" style="max-width: 200px;">${item.name}</span>
                    <button class="btn btn-link text-danger p-0" onclick="removeFromCart(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2">
                        <input type="number" class="qty-input form-control form-control-sm"
                            value="${item.quantity}" min="1" max="${item.stock}"
                            onchange="updateQuantity(${index}, this.value)">
                        <span class="text-muted">x</span>
                        <input type="number" class="price-input form-control form-control-sm"
                            value="${item.price.toFixed(2)}" step="0.50" min="0"
                            onchange="updatePrice(${index}, this.value)">
                    </div>
                    <span class="fw-bold">Bs ${subtotal.toFixed(2)}</span>
                </div>
            </div>
            `;
        }).join('');

        totalAmountEl.textContent = `Bs ${total.toFixed(2)}`;
        subtotalAmountEl.textContent = `Bs ${total.toFixed(2)}`;
    }

    function resetCart() {
        cart = [];
        renderCart();
        location.reload();
    }

    function checkout() {
        if (cart.length === 0) return;

        // Populate Confirmation Modal
        let total = 0;
        let html = '';

        cart.forEach(item => {
            const subtotal = item.quantity * item.price;
            total += subtotal;
            html += `
            <tr>
                <td>
                    <div class="fw-bold text-truncate" style="max-width: 200px;">${item.name}</div>
                    <small class="text-muted">Bs ${item.price.toFixed(2)} c/u</small>
                </td>
                <td class="text-center align-middle">${item.quantity}</td>
                <td class="text-end align-middle fw-bold">Bs ${subtotal.toFixed(2)}</td>
            </tr>
            `;
        });

        confirmationItems.innerHTML = html;
        confirmationTotal.textContent = `Bs ${total.toFixed(2)}`;

        confirmationModal.show();
    }

    async function processSale() {
        if (cart.length === 0) return;

        confirmSaleBtn.disabled = true;
        const originalText = confirmSaleBtn.innerHTML;
        confirmSaleBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Procesando...';

        try {
            const response = await fetch('{% url "create_sale" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ items: cart })
            });

            const data = await response.json();

            if (data.success) {
                confirmationModal.hide();
                document.getElementById('receiptNumber').textContent = data.sale_id;
                printReceiptBtn.href = `/sales/receipt/${data.sale_id}/`;
                checkoutModal.show();
            } else {
                alert('Error al procesar la venta: ' + data.error);
                confirmSaleBtn.disabled = false;
                confirmSaleBtn.innerHTML = originalText;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Ocurrió un error inesperado.');
            confirmSaleBtn.disabled = false;
            confirmSaleBtn.innerHTML = originalText;
        }
    }
</script>
{% endblock %}